<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Andy Forsberg â€” Composer + Producer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0b0b;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --line:rgba(255,255,255,.12);

      /* Jewel tones (no pastels) */
      --j1:#7a5cff; /* violet */
      --j2:#2563eb; /* blue */
      --j3:#06b6d4; /* cyan */
      --j4:#22c55e; /* green */
      --j5:#f59e0b; /* amber */
      --j6:#f97316; /* orange */
      --j7:#ef4444; /* red */
      --j8:#db2777; /* pink */

      --jt:var(--j1);
      --topbarH:64px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    /* ðŸš« No vertical scroll anywhere */
    body{ overflow:hidden; }

    /* ================= Topbar ================= */
    .topbar{
      position:fixed;
      left:0; right:0; top:0;
      z-index:1000;
      height:var(--topbarH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:14px 18px;
      background:rgba(11,11,11,.70);
      backdrop-filter: blur(16px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }

    .brand{
      display:flex;
      align-items:baseline;
      gap:10px;
      text-decoration:none;
      color:var(--text);
      min-width:0;
    }
    .brand__name{
      font-weight:500;
      letter-spacing:-.01em;
      font-size:15px;
      white-space:nowrap;
    }
    .brand__role{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.55);
      white-space:nowrap;
    }

    .topbar__right{
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* Social buttons (stable) */
    .sbtn{
      font-size:11px;
      letter-spacing:.16em;
      text-transform:uppercase;
      padding:9px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      color:rgba(255,255,255,.68);
      text-decoration:none;
      transition:transform .16s ease, background .16s ease, border-color .16s ease, color .16s ease;
      user-select:none;
      white-space:nowrap;
    }
    .sbtn:hover{ transform:translateY(-1px); }
    .sbtn:hover{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.92);
    }
    /* Jewel fill (no neon) */
    .sbtn.jewel:hover{
      border-color: var(--jt);
      background: rgba(255,255,255,.02);
      box-shadow: inset 0 0 0 999px rgba(0,0,0,.00);
      background: rgba(0,0,0,.0);
    }
    .sbtn.jewel:hover{
      background: color-mix(in srgb, var(--jt) 22%, transparent);
    }
    /* Fallback if color-mix unsupported */
    @supports not (background: color-mix(in srgb, #000 10%, transparent)){
      .sbtn.jewel:hover{ background: rgba(122,92,255,.18); }
    }

    .topbar__nav{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .navBtn{
      width:40px; height:40px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      color:rgba(255,255,255,.90);
      cursor:pointer;
      font-size:18px;
      transition:transform .16s ease, background .16s ease, border-color .16s ease;
      user-select:none;
    }
    .navBtn:hover{
      transform:translateY(-1px);
      border-color: var(--jt);
      background: color-mix(in srgb, var(--jt) 16%, transparent);
    }
    @supports not (background: color-mix(in srgb, #000 10%, transparent)){
      .navBtn:hover{ background: rgba(122,92,255,.18); }
    }

    .navDots{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .dot{
      width:6px; height:6px;
      border-radius:999px;
      background:rgba(255,255,255,.22);
    }
    .dot.is-on{ background:rgba(255,255,255,.82); }

    /* ================= Horizontal rail ================= */
    .rail{
      position:fixed;
      inset:0;
      padding-top:var(--topbarH);
      overflow-x:auto;
      overflow-y:hidden;
      display:flex;
      scroll-snap-type:x mandatory;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior: none;
    }

    .tile{
      flex:0 0 100vw;
      height:calc(100vh - var(--topbarH));
      scroll-snap-align:start;
      position:relative;
    }

    .tile__inner{
      height:100%;
      width:100%;
      padding:18px;
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .panel{
      width:min(1240px, 100%);
      height:100%;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      overflow:hidden; /* prevents accidental scrollbars */
      padding:18px;
    }

    .panel__title{
      font-size:12px;
      letter-spacing:.20em;
      text-transform:uppercase;
      color:rgba(255,255,255,.62);
      margin:2px 0 14px;
    }

    /* HOME tile */
    .heroCard{
      width:min(1240px, 100%);
      height:100%;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      overflow:hidden;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .heroTitle{
      margin:0;
      font-weight:500;
      letter-spacing:-.02em;
      font-size:clamp(28px, 3.2vw, 44px);
      line-height:1.08;
    }
    .heroSub{
      margin:0;
      color:rgba(255,255,255,.62);
      max-width:72ch;
      font-size:14px;
      line-height:1.6;
      min-height:1em;
    }

    .edgeHint{
      position:absolute;
      right:16px;
      bottom:14px;
      font-size:11px;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:rgba(255,255,255,.35);
      user-select:none;
    }

    /* ================= Player ================= */
    .playerShell{
      margin-top:auto;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      padding:16px;
    }

    .np{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .playBtn{
      width:54px; height:54px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.02);
      color:rgba(255,255,255,.92);
      cursor:pointer;
      font-size:16px;
      transition:transform .16s ease, background .16s ease, border-color .16s ease;
      user-select:none;
    }
    .playBtn:hover{
      transform:translateY(-1px);
      border-color: var(--jt);
      background: color-mix(in srgb, var(--jt) 16%, transparent);
    }
    @supports not (background: color-mix(in srgb, #000 10%, transparent)){
      .playBtn:hover{ background: rgba(122,92,255,.18); }
    }

    .np__meta{ min-width:0; }
    .npTitle{
      font-weight:500;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .npTime{
      margin-top:4px;
      font-size:12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:rgba(255,255,255,.50);
    }

    .wave{
      margin-top:14px;
      width:100%;
      height:86px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.35);
      overflow:hidden;
      cursor:pointer;
      user-select:none;
    }
    .wave canvas{ width:100%; height:100%; display:block; }

    .tracklist{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      cursor:pointer;
      transition:transform .16s ease, background .16s ease, border-color .16s ease;
      user-select:none;
    }
    .row:hover{
      transform:translateY(-1px);
      border-color: var(--jt);
      background: color-mix(in srgb, var(--jt) 16%, transparent);
    }
    @supports not (background: color-mix(in srgb, #000 10%, transparent)){
      .row:hover{ background: rgba(122,92,255,.18); }
    }
    .row.is-active{
      border-color:rgba(255,255,255,.18);
      background:rgba(255,255,255,.05);
    }
    .row__t{
      font-size:13px;
      font-weight:500;
      color:rgba(255,255,255,.86);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ================= Posters ================= */
    .posters{
      height:calc(100% - 38px);
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:18px;
      align-content:start;
    }

    .poster{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      cursor:pointer;
      transition:transform .16s ease, border-color .16s ease, background .16s ease;
      user-select:none;
    }
    .poster:hover{
      transform:translateY(-2px);
      border-color: var(--jt);
      background: color-mix(in srgb, var(--jt) 12%, transparent);
    }
    @supports not (background: color-mix(in srgb, #000 10%, transparent)){
      .poster:hover{ background: rgba(122,92,255,.14); }
    }
    .poster__img{
      aspect-ratio:2/3;
      width:100%;
      background-size:cover;
      background-position:center;
    }

    /* ================= Bio + Rep ================= */
    .panel--split{
      display:grid;
      grid-template-columns: 1.25fr 1fr;
      gap:18px;
      height:100%;
    }

    .bioBlock{
      height:100%;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      overflow:hidden;
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:0;
    }

    .bioPic{
      background:rgba(255,255,255,.03);
      border-right:1px solid rgba(255,255,255,.08);
      background-size:cover;
      background-position:center;
      min-height:0;
    }

    .bioCopy{
      padding:16px;
      min-width:0;
      overflow:hidden;
    }
    .bioName{ margin:0 0 6px 0; }
    .bioLine{ margin:0 0 12px 0; color:rgba(255,255,255,.70); }
    .bioBody p{
      margin:0 0 10px 0;
      line-height:1.55;
      color:rgba(255,255,255,.82);
      font-size:14px;
    }

    .repBlock{
      height:100%;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      overflow:hidden;
      padding:16px;
      min-height:0;
    }
    .repTitle{
      font-size:12px;
      letter-spacing:.20em;
      text-transform:uppercase;
      color:rgba(255,255,255,.62);
      margin-bottom:12px;
    }
    .repBody{
      color:rgba(255,255,255,.82);
      line-height:1.55;
      font-size:14px;
      overflow:hidden;
    }

    /* ================= Lightbox ================= */
    .lb{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .lb[aria-hidden="false"]{ display:flex; }
    .lb__bg{ position:absolute; inset:0; background:rgba(0,0,0,.78); }
    .lb__panel{
      position:relative;
      width:min(980px, calc(100% - 26px));
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:#0d0d0d;
    }
    .lb__close{
      position:absolute;
      top:10px; right:10px;
      width:42px; height:42px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      z-index:2;
      user-select:none;
    }
    .lb__img{
      display:block;
      width:100%;
      height:auto;
      max-height:82vh;
      object-fit:contain;
      background:#0b0b0b;
    }

    /* ================= Responsive ================= */
    @media (max-width: 980px){
      .topbar__right{ display:none; }
      .posters{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
      .panel--split{ grid-template-columns:1fr; }
      .bioBlock{ grid-template-columns: 220px 1fr; }
    }
    @media (max-width: 560px){
      .bioBlock{ grid-template-columns:1fr; }
      .bioPic{ height:220px; border-right:none; border-bottom:1px solid rgba(255,255,255,.08); }
    }
  </style>
</head>

<body>
  <header class="topbar" role="banner">
    <a class="brand" href="#home" data-goto="0" aria-label="Go to Home">
      <span class="brand__name" id="brandName">Andy Forsberg</span>
      <span class="brand__role">Composer + Producer</span>
    </a>

    <nav class="topbar__nav" aria-label="Primary">
      <button class="navBtn" type="button" data-nav="prev" aria-label="Previous section">â€¹</button>
      <div class="navDots" aria-hidden="true"></div>
      <button class="navBtn" type="button" data-nav="next" aria-label="Next section">â€º</button>
    </nav>

    <div class="topbar__right">
      <a class="sbtn jewel" href="https://www.imdb.com/name/nm4586039/" target="_blank" rel="noreferrer">IMDb</a>
      <a class="sbtn jewel" href="https://open.spotify.com/artist/5qd9swGpjTt9VJj0x053B3" target="_blank" rel="noreferrer">Spotify</a>
      <a class="sbtn jewel" href="https://music.apple.com/us/artist/andy-forsberg/987738278" target="_blank" rel="noreferrer">Apple Music</a>
      <a class="sbtn jewel" href="https://www.instagram.com/aforsbergmusic" target="_blank" rel="noreferrer">Instagram</a>
    </div>
  </header>

  <main id="rail" class="rail" aria-label="Site sections">
    <!-- TILE 1: HOME -->
    <section class="tile" data-title="Home" aria-label="Home">
      <div class="tile__inner">
        <div class="heroCard">
          <h1 class="heroTitle">Listening room</h1>
          <p class="heroSub" id="listeningCopy"></p>

          <div class="playerShell" aria-label="Music player">
            <div class="np">
              <button class="playBtn" type="button" aria-label="Play/Pause">â–¶</button>
              <div class="np__meta">
                <div class="npTitle">â€”</div>
                <div class="npTime">0:00 / 0:00</div>
              </div>
            </div>

            <div class="wave" role="button" tabindex="0" aria-label="Seek waveform">
              <canvas></canvas>
            </div>

            <div class="tracklist" aria-label="Track list"></div>
          </div>
        </div>

        <div class="edgeHint" aria-hidden="true">Scroll â†’</div>
      </div>
    </section>

    <!-- TILE 2: FEATURED PROJECTS -->
    <section class="tile" data-title="Featured Projects" aria-label="Featured Projects">
      <div class="tile__inner">
        <div class="panel">
          <div class="panel__title">Featured projects</div>
          <div class="posters" aria-label="Project posters"></div>
        </div>
      </div>
    </section>

    <!-- TILE 3: BIO + REP -->
    <section class="tile" data-title="Bio" aria-label="Bio and representation">
      <div class="tile__inner">
        <div class="panel panel--split">
          <div class="bioBlock">
            <div class="bioPic" id="bioPic" aria-hidden="true"></div>

            <div class="bioCopy">
              <p class="bioName"><strong>Andy Forsberg</strong></p>
              <p class="bioLine">is a composer and producer based in Los Angeles.</p>

              <div class="bioBody">
                <p>His work blends neoclassical textures, electronic sound design, and orchestral writing across film, television, and interactive media.</p>
                <p>He has composed music for projects with <strong>Disney</strong>, <strong>National Geographic</strong>, <strong>BBC</strong>, <strong>Apple</strong>, <strong>History Channel</strong>, <strong>Discovery</strong>, <strong>Hulu</strong>, <strong>Lifetime</strong>, and <strong>Hallmark</strong>.</p>
                <p>A percussionist and conductor, he is closely involved in the performance of his scores and productions, from the writing room to the podium.</p>
                <p>His approach prioritizes emotional clarity, nuance, and attention to detail.</p>
              </div>
            </div>
          </div>

          <div class="repBlock">
            <div class="repTitle">Representation / Inquiries</div>
            <div class="repBody" id="repCopy">
              <!-- PASTE YOUR EXACT REP + INQUIRY COPY HERE (keep it concise for no vertical scroll) -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Lightbox -->
    <div class="lb" aria-hidden="true">
      <div class="lb__bg" aria-hidden="true"></div>
      <div class="lb__panel" role="dialog" aria-modal="true" aria-label="Image viewer">
        <button class="lb__close" type="button" aria-label="Close">âœ•</button>
        <img class="lb__img" alt="" />
      </div>
    </div>
  </main>

  <script>
    (() => {
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

      /* Jewel tones */
      const JEWELS = ["#7a5cff","#2563eb","#06b6d4","#22c55e","#f59e0b","#f97316","#ef4444","#db2777"];
      const pickJewel = () => JEWELS[Math.floor(Math.random() * JEWELS.length)];
      const setJewel = (hex) => document.documentElement.style.setProperty("--jt", hex);

      /* Dropbox raw helper */
      const toDropboxRaw = (url) => {
        try {
          const u = new URL(url);
          if (u.hostname.includes("dropbox.com")) {
            u.searchParams.set("raw", "1");
            u.searchParams.delete("dl");
            return u.toString();
          }
          return url;
        } catch { return url; }
      };

      /* Data */
      const BIO_PIC = toDropboxRaw("https://www.dropbox.com/scl/fi/3b49pfk6pdgq0lh8851bl/Studio-Hygge-2023-20.jpeg?rlkey=mvh0b6wvlyy734zvw8z5jbuir&dl=0");

      const PROJECTS = [
        { title: "Hilinski's Hope", img: "https://www.dropbox.com/scl/fi/jj5d38zq6k5ze1j6x8rfb/Hilinski-s-Hope.webp?rlkey=okcz7ji4e77001w20zdbu5up6&raw=1" },
        { title: "The Secret Lives of Animals", img: "https://www.dropbox.com/scl/fi/9g8f8xyggs3dqlg1hmbao/The-Secret-Lives-of-Animals.webp?rlkey=s6yz5mrdz88uc9djbscr48urp&raw=1" },
        { title: "Europe From Above", img: "https://images.squarespace-cdn.com/content/693fe31c2851f35786f384ab/5ac55c58-6244-48de-9504-705a76b505c1/MV5BMWM1YzM4ZTYtOTNhYi00YTg2LWJlOTItMTNiMWFlMmI4MTE5XkEyXkFqcGc%40._V1_.jpg?content-type=image%2Fjpeg" },
        { title: "Born Wild: The Next Generation", img: "https://www.dropbox.com/scl/fi/04mok8tmb3dvvq6pofbrw/Born-Wild-The-Next-Generation.webp?rlkey=iq4b92tcumfktib1xm0t8eug1&raw=1" },
        { title: "Dodo Heroes", img: "https://images.squarespace-cdn.com/content/693fe31c2851f35786f384ab/6b91b60c-fc0d-494c-8252-6ddb0338bcfe/Dodo+Heroes.jpg?content-type=image%2Fjpeg" },
        { title: "The Last Alaskans", img: "https://www.dropbox.com/scl/fi/7u94wz7f4jbes9qr6iytz/The-Last-Alaskans.webp?rlkey=apub8dab1r8c79n3h2kdd46gu&raw=1" },
        { title: "Thirst", img: "https://images.squarespace-cdn.com/content/693fe31c2851f35786f384ab/98561fee-a1fe-4c77-a6a9-4ec0537a73a1/Thirst.webp?content-type=image%2Fwebp" },
        { title: "Whistle", img: "https://www.dropbox.com/scl/fi/6sp81uysuvokjyt2j3rac/Whistle.jpg?rlkey=58x5sqlr9u1ic77fb25nkfk3q&raw=1" }
      ];

      const TRACKS = [
        { title: "Charlie Horse", src: "https://audio.squarespace-cdn.com/content/v2/namespaces/website/libraries/693fe31c2851f35786f384ab/assets/9b1a0c45-e055-4c88-b7b3-5f68e21c868e/Charlie%20Horse.mp3" },
        { title: "Beneath The City", src: "https://audio.squarespace-cdn.com/content/v2/namespaces/website/libraries/693fe31c2851f35786f384ab/assets/7a797f68-c4b0-48a2-bd22-2e4d0d42cb3f/Beneath%20The%20City.mp3" },
        { title: "Stars To Guide Us", src: "https://audio.squarespace-cdn.com/content/v2/namespaces/website/libraries/693fe31c2851f35786f384ab/assets/e08b2007-7b7a-45b5-9bc2-5e16f7c663f1/Stars%20To%20Guide%20Us.mp3" },
        { title: "Drive To Isleworth", src: "https://audio.squarespace-cdn.com/content/v2/namespaces/website/libraries/693fe31c2851f35786f384ab/assets/e021b12d-70ad-45ad-8372-54e5bad51945/Drive%20To%20Isleworth.mp3" }
      ];

      const clamp01 = (x) => Math.max(0, Math.min(1, x));
      const fmtTime = (s) => {
        if (!isFinite(s) || s < 0) return "0:00";
        const m = Math.floor(s / 60);
        const r = Math.floor(s % 60);
        return `${m}:${String(r).padStart(2, "0")}`;
      };

      function sizeCanvasToCSS(canvas) {
        const rect = canvas.getBoundingClientRect();
        const dpr = Math.min(2, window.devicePixelRatio || 1);
        const w = Math.max(1, Math.floor(rect.width * dpr));
        const h = Math.max(1, Math.floor(rect.height * dpr));
        if (canvas.width !== w || canvas.height !== h) {
          canvas.width = w;
          canvas.height = h;
        }
      }

      function drawWave(canvas, peaks, progress01) {
        if (!canvas || !peaks?.length) return;
        const ctx = canvas.getContext("2d");
        const w = canvas.width, h = canvas.height;
        ctx.clearRect(0, 0, w, h);

        const p = clamp01(progress01 || 0);
        const progX = p * w;

        const base = "rgba(255,255,255,0.10)";
        const jewel = getComputedStyle(document.documentElement).getPropertyValue("--jt").trim() || "#7a5cff";

        const mid = h * 0.5;
        const stride = 6.0;
        const barW = 5.2;
        const minAmp = 6;
        const maxAmp = h * 0.46;
        const cols = Math.max(1, Math.floor(w / stride));
        const n = peaks.length;
        const getPeak = (idx) => peaks[Math.max(0, Math.min(n - 1, idx))];

        for (let col = 0; col < cols; col++) {
          const x = col * stride;
          const t = cols <= 1 ? 0 : col / (cols - 1);
          const f = t * (n - 1);
          const i0 = Math.floor(f);
          const i1 = Math.min(n - 1, i0 + 1);
          const frac = f - i0;
          const p0 = getPeak(i0) * (1 - frac) + getPeak(i1) * frac;
          const shaped = Math.sqrt(Math.max(0, p0));
          const amp = Math.max(minAmp, shaped * maxAmp);

          const y0 = mid - amp;
          const hh = amp * 2;
          const rx = x + (stride - barW) * 0.5;

          ctx.fillStyle = (x <= progX) ? jewel : base;

          if (ctx.roundRect) {
            ctx.beginPath();
            ctx.roundRect(rx, y0, barW, hh, 999);
            ctx.fill();
          } else {
            ctx.fillRect(rx, y0, barW, hh);
          }
        }
      }

      /* Peaks cache */
      const PEAKS_N = 220;
      const waveCache = new Map();
      let AUDIO_CTX = null;
      const getAudioCtx = () => (AUDIO_CTX ||= new (window.AudioContext || window.webkitAudioContext)());

      function computePeaks(audioBuffer, n) {
        const ch0 = audioBuffer.getChannelData(0);
        const ch1 = audioBuffer.numberOfChannels > 1 ? audioBuffer.getChannelData(1) : null;
        const len = audioBuffer.length;
        const step = Math.max(1, Math.floor(len / n));
        const peaks = new Array(n);

        for (let i = 0; i < n; i++) {
          const start = i * step;
          const end = Math.min(len, start + step);
          let max = 0;
          for (let j = start; j < end; j++) {
            const v0 = Math.abs(ch0[j]);
            const v = ch1 ? Math.max(v0, Math.abs(ch1[j])) : v0;
            if (v > max) max = v;
          }
          peaks[i] = max;
        }

        let pmax = 0;
        for (const p of peaks) if (p > pmax) pmax = p;
        const inv = pmax ? 1 / pmax : 1;
        for (let i = 0; i < peaks.length; i++) peaks[i] = Math.min(1, peaks[i] * inv);
        return peaks;
      }

      async function getPeaks(src) {
        if (!src) return null;
        if (waveCache.has(src)) return waveCache.get(src);

        const ctx = getAudioCtx();
        const res = await fetch(src, { mode: "cors", cache: "force-cache" });
        const buf = await res.arrayBuffer();
        const decoded = await ctx.decodeAudioData(buf);
        const peaks = computePeaks(decoded, PEAKS_N);
        const out = { peaks, duration: decoded.duration };
        waveCache.set(src, out);
        return out;
      }

      function setupRail() {
        const rail = $("#rail");
        if (!rail) return;

        const tiles = $$(".tile", rail);
        const prevBtn = $("[data-nav='prev']");
        const nextBtn = $("[data-nav='next']");
        const dotsWrap = $(".navDots");

        if (dotsWrap) {
          dotsWrap.innerHTML = tiles.map((_, i) => `<span class="dot ${i===0?'is-on':''}" data-dot="${i}"></span>`).join("");
        }

        const snapTo = (i) => {
          const idx = Math.max(0, Math.min(tiles.length - 1, i));
          const x = idx * rail.clientWidth;
          rail.scrollTo({ left: x, behavior: "smooth" });
        };

        const getIndex = () => {
          const w = rail.clientWidth || 1;
          return Math.round(rail.scrollLeft / w);
        };

        const updateUI = () => {
          const i = getIndex();
          $$(".dot", dotsWrap || document).forEach(d => d.classList.toggle("is-on", Number(d.dataset.dot) === i));
        };

        prevBtn?.addEventListener("click", () => snapTo(getIndex() - 1));
        nextBtn?.addEventListener("click", () => snapTo(getIndex() + 1));

        dotsWrap?.addEventListener("click", (e) => {
          const dot = e.target.closest(".dot");
          if (!dot) return;
          snapTo(Number(dot.dataset.dot));
        });

        window.addEventListener("keydown", (e) => {
          if (e.key === "ArrowRight") snapTo(getIndex() + 1);
          if (e.key === "ArrowLeft") snapTo(getIndex() - 1);
        });

        /* Wheel â†’ horizontal (critical) */
        rail.addEventListener("wheel", (e) => {
          if (e.ctrlKey) return;
          e.preventDefault();
          const dx = Math.abs(e.deltaX);
          const dy = Math.abs(e.deltaY);
          rail.scrollLeft += (dy > dx ? e.deltaY : e.deltaX);
        }, { passive: false });

        rail.addEventListener("scroll", () => updateUI(), { passive: true });

        $$("[data-goto]").forEach(el => {
          el.addEventListener("click", (e) => {
            e.preventDefault();
            snapTo(Number(el.dataset.goto));
          });
        });

        updateUI();
      }

      function setupPosters() {
        const postersEl = $(".posters");
        if (!postersEl) return;

        postersEl.innerHTML = PROJECTS.map((p, i) => `
          <div class="poster" data-idx="${i}" role="button" aria-label="Open ${p.title}">
            <div class="poster__img" style="background-image:url('${p.img || ""}')"></div>
          </div>
        `).join("");

        const lb = $(".lb");
        const lbImg = $(".lb__img");
        const lbBg = $(".lb__bg");
        const lbClose = $(".lb__close");

        const openLB = (imgUrl) => {
          if (!lb || !lbImg) return;
          lbImg.src = imgUrl;
          lb.setAttribute("aria-hidden", "false");
        };
        const closeLB = () => {
          if (!lb) return;
          lb.setAttribute("aria-hidden", "true");
          if (lbImg) lbImg.src = "";
        };

        postersEl.addEventListener("click", (e) => {
          const p = e.target.closest(".poster");
          if (!p) return;
          const idx = Number(p.dataset.idx);
          const item = PROJECTS[idx];
          if (item?.img) openLB(item.img);
        });

        lbBg?.addEventListener("click", closeLB);
        lbClose?.addEventListener("click", closeLB);
        window.addEventListener("keydown", (e) => e.key === "Escape" && closeLB());
      }

      function setupPlayer() {
        const playBtn = $(".playBtn");
        const npTitle = $(".npTitle");
        const npTime = $(".npTime");
        const waveBtn = $(".wave");
        const waveCanvas = waveBtn ? $("canvas", waveBtn) : null;
        const tracklist = $(".tracklist");
        if (!tracklist || !TRACKS.length) return;

        const audio = new Audio();
        audio.preload = "metadata";

        let idx = 0;
        let peaksObj = null;
        let raf = null;

        const setPlayIcon = () => { if (playBtn) playBtn.textContent = audio.paused ? "â–¶" : "âšâš"; };
        const renderTracklist = () => {
          tracklist.innerHTML = TRACKS.map((t, i) => `
            <div class="row ${i===idx?'is-active':''}" data-i="${i}">
              <div class="row__t">${t.title || "Untitled"}</div>
              <div class="row__d"></div>
            </div>
          `).join("");
        };
        const dur = () => (isFinite(audio.duration) && audio.duration > 0) ? audio.duration : (peaksObj?.duration || 0);

        const tick = () => {
          const d = dur();
          const c = isFinite(audio.currentTime) ? audio.currentTime : 0;
          const pct = d ? clamp01(c / d) : 0;

          npTitle.textContent = TRACKS[idx]?.title || "Untitled";
          npTime.textContent = `${fmtTime(c)} / ${fmtTime(d)}`;
          setPlayIcon();

          if (waveCanvas && peaksObj?.peaks) {
            sizeCanvasToCSS(waveCanvas);
            drawWave(waveCanvas, peaksObj.peaks, pct);
          }

          $$(".row", tracklist).forEach(r => {
            const i = Number(r.dataset.i);
            r.classList.toggle("is-active", i === idx);
          });

          if (!audio.paused) raf = requestAnimationFrame(tick);
          else raf = null;
        };

        const load = async (i, autoplay) => {
          idx = (i + TRACKS.length) % TRACKS.length;
          const t = TRACKS[idx];
          audio.src = t.src;
          audio.currentTime = 0;

          setJewel(pickJewel());

          peaksObj = null;
          try { peaksObj = await getPeaks(t.src); } catch { peaksObj = null; }

          renderTracklist();
          cancelAnimationFrame(raf);
          raf = requestAnimationFrame(tick);

          if (autoplay) audio.play().catch(() => {});
        };

        const toggle = () => {
          if (!audio.src) { load(0, true); return; }
          if (audio.paused) audio.play().catch(() => {});
          else audio.pause();
          cancelAnimationFrame(raf);
          raf = requestAnimationFrame(tick);
        };

        const seekFromEvent = (e) => {
          if (!peaksObj) return;
          const rect = waveBtn.getBoundingClientRect();
          const x = Math.min(Math.max(0, e.clientX - rect.left), rect.width);
          const pct = rect.width ? x / rect.width : 0;
          const d = dur();
          if (!d) return;
          audio.currentTime = pct * d;
          cancelAnimationFrame(raf);
          raf = requestAnimationFrame(tick);
        };

        playBtn?.addEventListener("click", toggle);
        tracklist.addEventListener("click", (e) => {
          const row = e.target.closest(".row");
          if (!row) return;
          const i = Number(row.dataset.i);
          if (i === idx) toggle();
          else load(i, true);
        });

        waveBtn?.addEventListener("pointerdown", (e) => {
          waveBtn.setPointerCapture(e.pointerId);
          seekFromEvent(e);
        });
        waveBtn?.addEventListener("pointermove", (e) => {
          if (e.buttons) seekFromEvent(e);
        });

        audio.addEventListener("play", () => {
          cancelAnimationFrame(raf);
          raf = requestAnimationFrame(tick);
        });
        audio.addEventListener("pause", () => {
          cancelAnimationFrame(raf);
          raf = requestAnimationFrame(tick);
        });
        audio.addEventListener("ended", () => load(idx + 1, true));

        renderTracklist();
        load(0, false);
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Baseline jewel
        setJewel(pickJewel());

        // Bio pic
        const bioPic = $("#bioPic");
        if (bioPic) bioPic.style.backgroundImage = `url('${BIO_PIC}')`;

        // Brand + socials randomize jewel
        $("#brandName")?.addEventListener("mouseenter", () => setJewel(pickJewel()));
        $$(".sbtn.jewel").forEach(a => a.addEventListener("mouseenter", () => setJewel(pickJewel())));

        setupRail();
        setupPosters();
        setupPlayer();
      });
    })();
  </script>
</body>
</html>
